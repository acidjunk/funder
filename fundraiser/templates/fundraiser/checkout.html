{% extends "base.html" %}
{% load gravatar humanize wagtailcore_tags wagtailimages_tags static i18n %}
{% block content %}

<h1 class="ui dividing header">
    {% trans "Checkout" %}
</h1>

<form method="post" class="ui form" id="funder_checkout_form" action="/order/start-payment/">
    {% csrf_token %}
    <input type="hidden" name="provider_id">

    <div class="ui stackable grid">
        <div class="eleven wide column">
            <div class="ui segment"><p>{% trans "Check the form, and then click one of the banks to complete your donation." %}</p>
                <div class="ui equal width form">
                    <div class="fields">
                        <div class="required field">
                            <label>{% trans "Name" %}</label>
                            <input name="name" type="text" placeholder="{% trans "Your name" %}"
                                    {% if request.session.funder_name %}
                                   value="{{ request.session.funder_name }}"{% endif %}>
                        </div>
                        <div class="field">
                            <label>{% trans "Organisation" %}</label>
                            <input name="organisation" type="text" placeholder="{% trans "Your organisation's name if any"%}"
                                    {% if request.session.funder_organisation %}
                                   value="{{ request.session.funder_organisation }}"{% endif %}>
                        </div>
                    </div>
                    <div class="fields">
                        <div class="field">
                            <label>{% trans "Email" %}</label>
                            <input type="text" name="email" placeholder="{% trans "Email" %}">
                        </div>
                        <div class="field"><label>{% trans "Anonymous?" %}</label>

                            <div class="ui toggle checkbox">
                                <input type="checkbox" name="anonymous" tabindex="0" class="hidden">
                                <label>{% trans "Do not show my name on the project pages" %}</label>
                            </div>
                        </div>
                    </div>
                    <div class="field">
                      <label>{% trans "I agree to the" %} <a href="">{% trans "terms and conditions" %}</a></label>
                      <input type="checkbox" name="terms">
                    </div>
                </div>
            </div>
            <div class="ui error message"></div>

            <h2 class="ui dividing header">{% trans "Choose a bank to continue" %}</h2>
            {% if banks %}
                <div class="ui three doubling link cards">
                    {% for bank in banks %}
                        <div class="ui card" data-value="{{ bank.id }}">
                            <div class="content">{{ bank.name }}</div>
                            <div class="blurring dimmable image">
                                <div class="ui dimmer">
                                    <div class="content">
                                    </div>
                                </div>
                                <img src="/static/images/sisow/providers/{{ bank.name }}.png">
                            </div>
                      </div>
                    {% endfor %}
                </div>
            {% endif %}

        </div>
        <div class="five wide column">
            <div class="ui raised segment">
                <h1 class="ui header">
                    <i class="shopping cart icon"></i>
                    <div class="content">Cart</div>
                </h1>

                <table class="ui very basic collapsing celled table">
                    <thead>
                        <tr>
                            <th>{% trans "Product/Project" %}</th>
                            <th>{% trans "Quantity" %}</th>
                            <th>{% trans "Price" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in cart %}
                        <tr>
                            <td>{{ item.product }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>{{ item.total_price }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3">
                                <div align="right">
                                    <i>{% trans "Total ex VAT" %}: </i>{{ total_without_vat }}<br>
                                    <i>{% trans "VAT" %}:</i>21%<br>
                                    <span style="font-size: 1.2rem;"><i>{% trans "Total with VAT" %}:</i>{{ total_with_vat }}</span>
                                </div>
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="ui raised segment">
                <h4>{% trans "Newsletter" %}</h4>
                <p>{% trans "Also subscribe to the newsletter?" %}</p>

                <div class="ui form">

                    <div class="field">
                        <div class="ui checkbox">
                            <input type="checkbox" tabindex="0" class="hidden">
                            <label>{% trans "Sign me up for the newsletter" %}</label>
                        </div>
                    </div>
                </div>
            </div>


        </div>

    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
$('.ui.card').on("click", function () {
    var provider_id = $(this).attr('data-value');
    $('input[name="provider_id"]').val(provider_id)
    $('#funder_checkout_form').submit();
});


$(document).ready(function() {

    // validation
    $('.ui.form').form({
        fields: {
            name: {
                identifier: 'name',
                rules: [
                    {
                        type: 'empty',
                        prompt: '{% trans "Please enter a name" %}'
                    }
                ]
            },

            email: {
                identifier: 'email',
                optional: true,
                rules: [
                    {
                        type: 'email',
                        prompt: '{% trans "Please enter a valid email address" %}'
                    }
                ]
            },

            terms: {
                identifier: 'terms',
                rules: [
                    {
                        type: 'checked',
                        prompt: '{% trans "You must agree to the terms and conditions" %}'
                    }
                ]
            }
        }
    });

    // called if correct data added to form
    function validationpassed() {

        // Multiple instances may have been bound to the form, only submit one.
        // This is a workaround and not ideal.
        // Improvements welcomed.

        if (window.lock != "locked") {
            var myform = $('.ui.form');
            $.ajax({
                type: myform.attr('method'),
                url: myform.attr('action'),
                data: myform.serialize(),
                success: function (data) {
                    //if successful at posting the form via ajax.
                    myformposted(data);
                    window.lock = "";
                }
            });
        }
        window.lock = "locked";
    }
});
</script>
{% endblock %}


